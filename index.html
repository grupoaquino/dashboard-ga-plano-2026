<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard GA 2026 - Grupo Aquino</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; }
    :root {
      --verde-escuro: #354F41;
      --verde-medio: #4A6B5D;
      --verde-claro: #5A8A73;
      --bege: #F5EDE4;
      --bege-escuro: #E8DFD4;
      --concluido: #22C55E;
      --em-andamento: #3B82F6;
      --pendente: #F59E0B;
      --atrasado: #EF4444;
    }
    body { background-color: var(--bege); }
    .card { background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .progress-bar { transition: width 1s ease-out; }
    .hover-scale { transition: transform 0.2s, box-shadow 0.2s; }
    .hover-scale:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.12); }
    .gradient-header { background: linear-gradient(135deg, var(--verde-escuro) 0%, var(--verde-medio) 50%, var(--verde-claro) 100%); }
  </style>
</head>
<body class="min-h-screen">
  <!-- Header -->
  <header class="gradient-header text-white py-5 px-4 shadow-xl">
    <div class="max-w-7xl mx-auto flex items-center justify-between flex-wrap gap-4">
      <div class="flex items-center gap-4">
        <div class="w-14 h-14 rounded-full flex items-center justify-center text-2xl font-serif shadow-lg border-2 border-white/30" style="background: var(--bege); color: var(--verde-escuro)">
          <span class="font-bold">Q</span>
        </div>
        <div>
          <h1 class="text-2xl font-extrabold tracking-wide">GRUPO AQUINO</h1>
          <p class="text-sm opacity-90">üìä Dashboard Planejamento Estrat√©gico 2026</p>
        </div>
      </div>
      <div class="text-right">
        <div class="flex items-center gap-2 justify-end">
          <span id="syncIndicator" class="w-2.5 h-2.5 rounded-full bg-yellow-400"></span>
          <span id="syncStatus" class="text-xs font-medium opacity-90">Conectando...</span>
        </div>
        <p id="lastUpdate" class="text-sm font-semibold mt-1">Aguardando...</p>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-4 space-y-5">
    <!-- Loading -->
    <div id="loading" class="card p-10 text-center">
      <div class="w-14 h-14 border-4 border-t-transparent rounded-full animate-spin mx-auto mb-4" style="border-color: var(--verde-escuro); border-top-color: transparent"></div>
      <p class="font-bold text-lg" style="color: var(--verde-escuro)">üîÑ Conectando √† planilha...</p>
      <p class="text-sm text-gray-500 mt-2">Sincronizando dados do Google Sheets</p>
    </div>

    <!-- Error -->
    <div id="errorState" class="card p-10 text-center hidden">
      <div class="text-5xl mb-4">‚ö†Ô∏è</div>
      <p class="text-red-500 font-bold text-xl">N√£o foi poss√≠vel conectar √† planilha</p>
      <p id="errorMessage" class="text-sm text-gray-500 mt-2 mb-6"></p>
      <div class="flex flex-col sm:flex-row gap-3 justify-center">
        <button onclick="fetchData()" class="px-6 py-3 bg-blue-500 text-white rounded-xl font-medium hover:bg-blue-600 transition shadow-lg">üîÑ Tentar novamente</button>
        <button onclick="useDemoData()" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition">üìä Ver demonstra√ß√£o</button>
      </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboardContent" class="hidden space-y-5">
      <div id="demoBanner" class="hidden bg-amber-50 border-l-4 border-amber-400 p-4 rounded-r-xl">
        <p class="text-sm text-amber-800 flex items-center gap-2 flex-wrap">
          <span class="font-bold">üìã Modo demonstra√ß√£o</span>
          <button onclick="fetchData()" class="ml-auto text-amber-600 hover:text-amber-800 underline font-medium">Reconectar</button>
        </p>
      </div>

      <!-- Cards -->
      <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
        <div class="card p-5 border-l-4 hover-scale" style="border-left-color: var(--verde-escuro)">
          <p class="text-xs font-semibold text-gray-400 uppercase">TOTAL</p>
          <p id="metricTotal" class="text-4xl font-extrabold mt-2" style="color: var(--verde-escuro)">0</p>
          <p id="metricPercent" class="text-xs mt-2 font-bold" style="color: var(--verde-medio)">0% conclu√≠do</p>
        </div>
        <div class="card p-5 border-l-4 hover-scale" style="border-left-color: var(--concluido)">
          <p class="text-xs font-semibold text-gray-400 uppercase">‚úÖ CONCLU√çDAS</p>
          <p id="metricConcluido" class="text-4xl font-extrabold mt-2" style="color: var(--verde-escuro)">0</p>
        </div>
        <div class="card p-5 border-l-4 hover-scale" style="border-left-color: var(--em-andamento)">
          <p class="text-xs font-semibold text-gray-400 uppercase">üîÑ EM ANDAMENTO</p>
          <p id="metricAndamento" class="text-4xl font-extrabold mt-2" style="color: var(--verde-escuro)">0</p>
        </div>
        <div class="card p-5 border-l-4 hover-scale" style="border-left-color: var(--pendente)">
          <p class="text-xs font-semibold text-gray-400 uppercase">‚è≥ PENDENTES</p>
          <p id="metricPendente" class="text-4xl font-extrabold mt-2" style="color: var(--verde-escuro)">0</p>
        </div>
        <div class="card p-5 border-l-4 hover-scale" style="border-left-color: var(--atrasado)">
          <p class="text-xs font-semibold text-gray-400 uppercase">‚ö†Ô∏è ATRASADAS</p>
          <p id="metricAtrasado" class="text-4xl font-extrabold mt-2" style="color: var(--verde-escuro)">0</p>
        </div>
      </div>

      <!-- Progress -->
      <div class="card p-6">
        <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
          <div>
            <h2 class="text-xl font-extrabold" style="color: var(--verde-escuro)">üéØ Progresso Geral 2026</h2>
            <p id="progressText" class="text-sm text-gray-500 mt-1">0 de 0 a√ß√µes conclu√≠das</p>
          </div>
          <button onclick="fetchData()" id="refreshBtn" class="px-5 py-2.5 rounded-xl text-sm font-bold hover:scale-105 shadow-md" style="background: var(--verde-escuro); color: white">üîÑ Atualizar</button>
        </div>
        <div class="flex items-center gap-6">
          <div class="flex-1 bg-gray-100 rounded-full h-5 overflow-hidden shadow-inner">
            <div id="progressBar" class="h-5 rounded-full progress-bar" style="width: 0%; background: linear-gradient(90deg, var(--concluido), #34D399)"></div>
          </div>
          <span id="progressPercent" class="text-5xl font-extrabold" style="color: var(--concluido)">0%</span>
        </div>
      </div>

      <!-- Charts -->
      <div class="grid md:grid-cols-2 gap-5">
        <div class="card p-6">
          <h2 class="text-lg font-bold mb-4" style="color: var(--verde-escuro)">üìä Status das A√ß√µes</h2>
          <div style="height: 250px;"><canvas id="pieChart"></canvas></div>
        </div>
        <div class="card p-6">
          <h2 class="text-lg font-bold mb-4" style="color: var(--verde-escuro)">üìà A√ß√µes por √Årea</h2>
          <div style="height: 250px;"><canvas id="barChart"></canvas></div>
        </div>
      </div>

      <!-- Area Progress -->
      <div class="card p-6">
        <h2 class="text-lg font-bold mb-5" style="color: var(--verde-escuro)">üè¢ Progresso por √Årea</h2>
        <div id="areaProgress" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </div>

      <!-- Table -->
      <div class="card p-6">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-5">
          <div>
            <h2 class="text-lg font-bold" style="color: var(--verde-escuro)">üìù Plano de A√ß√£o Detalhado</h2>
            <p id="tableCount" class="text-sm text-gray-500">Mostrando 0 a√ß√µes</p>
          </div>
          <div class="flex gap-3 flex-wrap">
            <select id="filterArea" onchange="filterTable()" class="px-4 py-2.5 rounded-xl border-2 text-sm font-medium bg-white" style="border-color: var(--bege-escuro)">
              <option value="">üè¢ Todas as √Åreas</option>
            </select>
            <select id="filterStatus" onchange="filterTable()" class="px-4 py-2.5 rounded-xl border-2 text-sm font-medium bg-white" style="border-color: var(--bege-escuro)">
              <option value="">üìä Todos os Status</option>
              <option value="CONCLU√çDO">‚úÖ Conclu√≠do</option>
              <option value="EM ANDAMENTO">üîÑ Em Andamento</option>
              <option value="PENDENTE">‚è≥ Pendente</option>
              <option value="ATRASADO">‚ö†Ô∏è Atrasado</option>
            </select>
          </div>
        </div>
        <div class="overflow-x-auto rounded-xl border" style="border-color: var(--bege-escuro)">
          <table class="w-full text-sm">
            <thead>
              <tr class="gradient-header">
                <th class="px-4 py-4 text-left font-bold text-white">√Årea</th>
                <th class="px-4 py-4 text-left font-bold text-white">A√ß√£o</th>
                <th class="px-4 py-4 text-left font-bold text-white">Respons√°vel</th>
                <th class="px-4 py-4 text-left font-bold text-white">Prazo</th>
                <th class="px-4 py-4 text-left font-bold text-white">Prioridade</th>
                <th class="px-4 py-4 text-left font-bold text-white">Status</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
        
        <!-- Pagina√ß√£o -->
        <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mt-5 pt-5 border-t" style="border-color: var(--bege-escuro)">
          <div class="flex items-center gap-2">
            <span class="text-sm text-gray-500">Exibir:</span>
            <select id="pageSize" onchange="changePageSize()" class="px-3 py-2 rounded-lg border-2 text-sm font-medium bg-white" style="border-color: var(--bege-escuro)">
              <option value="25">25 a√ß√µes</option>
              <option value="50" selected>50 a√ß√µes</option>
              <option value="100">100 a√ß√µes</option>
            </select>
          </div>
          
          <div class="flex items-center gap-2">
            <button onclick="goToPage(1)" id="btnFirst" class="px-3 py-2 rounded-lg text-sm font-medium transition hover:scale-105 disabled:opacity-40 disabled:cursor-not-allowed" style="background: var(--bege); color: var(--verde-escuro)">
              ‚èÆÔ∏è
            </button>
            <button onclick="goToPage(currentPage - 1)" id="btnPrev" class="px-3 py-2 rounded-lg text-sm font-medium transition hover:scale-105 disabled:opacity-40 disabled:cursor-not-allowed" style="background: var(--bege); color: var(--verde-escuro)">
              ‚óÄÔ∏è Anterior
            </button>
            
            <span id="pageInfo" class="px-4 py-2 rounded-lg text-sm font-bold" style="background: var(--verde-escuro); color: white">
              1 / 1
            </span>
            
            <button onclick="goToPage(currentPage + 1)" id="btnNext" class="px-3 py-2 rounded-lg text-sm font-medium transition hover:scale-105 disabled:opacity-40 disabled:cursor-not-allowed" style="background: var(--bege); color: var(--verde-escuro)">
              Pr√≥xima ‚ñ∂Ô∏è
            </button>
            <button onclick="goToPage(totalPages)" id="btnLast" class="px-3 py-2 rounded-lg text-sm font-medium transition hover:scale-105 disabled:opacity-40 disabled:cursor-not-allowed" style="background: var(--bege); color: var(--verde-escuro)">
              ‚è≠Ô∏è
            </button>
          </div>
          
          <div class="text-sm text-gray-500">
            <span id="showingRange">Mostrando 0-0</span> de <span id="totalFiltered">0</span>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="mt-10 py-8 text-center gradient-header">
    <p class="text-xl font-bold text-white">Grupo Aquino ¬© 2026</p>
    <p class="text-sm mt-2 text-white/80">"Ser a ess√™ncia da beleza, levando amor a todas as pessoas"</p>
    <p class="text-xs mt-4 text-white/50">Dashboard sincronizado ‚Ä¢ Atualiza√ß√£o autom√°tica a cada 2 min</p>
  </footer>

  <script>
    // ========== LINK CSV ==========
    const CSV_BASE = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSKoCXDY5_K6uL7-c24AWVkT-CYX6AkdKpgK0NRUPv-oQhxuAOlEQlajG576xREaQ/pub?gid=1551980844&single=true&output=csv';
    
    // Fun√ß√£o para gerar URLs com anti-cache
    function getCSVUrls() {
      const cacheBuster = `&_t=${Date.now()}`;
      const url = CSV_BASE + cacheBuster;
      return [
        url,
        `https://corsproxy.io/?${encodeURIComponent(url)}`,
        `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`
      ];
    }
    
    let allData = [];
    let pieChart = null;
    let barChart = null;
    let isUsingDemo = false;

    const colors = { concluido: '#22C55E', emAndamento: '#3B82F6', pendente: '#F59E0B', atrasado: '#EF4444' };

    // Vari√°veis de pagina√ß√£o
    let currentPage = 1;
    let pageSize = 50;
    let totalPages = 1;
    let filteredData = [];

    const demoData = [
      { area: 'Diretoria', acao: 'Definir meta macro 2026', prioridade: 'ALTA', status: 'EM ANDAMENTO', prazo: '31/01/2026', responsavel: 'Aliny' },
      { area: 'Ger√™ncia', acao: 'Documentar processos', prioridade: 'ALTA', status: 'PENDENTE', prazo: '28/02/2026', responsavel: 'Leida' },
    ];

    function normalizeStatus(s) {
      if (!s) return 'PENDENTE';
      const normalized = s.toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').trim();
      // Mapear varia√ß√µes
      if (normalized === 'CONCLUIDO' || normalized === 'CONCLU√çDA' || normalized === 'CONCLUIDA') return 'CONCLU√çDO';
      if (normalized.includes('ANDAMENTO')) return 'EM ANDAMENTO';
      if (normalized === 'ATRASADO' || normalized === 'ATRASADA') return 'ATRASADO';
      if (normalized === 'PENDENTE' || normalized === '') return 'PENDENTE';
      return normalized || 'PENDENTE';
    }

    async function fetchData() {
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('errorState').classList.add('hidden');
      document.getElementById('dashboardContent').classList.add('hidden');
      document.getElementById('syncIndicator').className = 'w-2.5 h-2.5 rounded-full bg-yellow-400 pulse';
      document.getElementById('syncStatus').textContent = 'Sincronizando...';
      
      const btn = document.getElementById('refreshBtn');
      if (btn) { btn.disabled = true; btn.innerHTML = '‚è≥ Carregando...'; }

      let success = false, lastError = null;

      for (const url of getCSVUrls()) {
        try {
          console.log('üîÑ Tentando:', url.substring(0, 60));
          const controller = new AbortController();
          const timeout = setTimeout(() => controller.abort(), 15000);
          
          const res = await fetch(url, { signal: controller.signal, headers: { 'Accept': 'text/csv,*/*' } });
          clearTimeout(timeout);
          
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const text = await res.text();
          
          if (!text || text.length < 20 || text.includes('<!DOCTYPE')) throw new Error('Resposta inv√°lida');

          console.log('üìÑ CSV recebido, tamanho:', text.length);

          const parsed = Papa.parse(text, { 
            header: true, 
            skipEmptyLines: 'greedy', // Ignora linhas completamente vazias
            transformHeader: h => h.trim()
          });
          
          console.log('üìã Colunas encontradas:', parsed.meta.fields);
          console.log('üìä Total de linhas no CSV:', parsed.data.length);

          // Fun√ß√£o para buscar valor em m√∫ltiplas varia√ß√µes de nome de coluna
          const getValue = (row, ...keys) => {
            for (const key of keys) {
              // Tenta exatamente como est√°
              if (row[key] !== undefined && row[key] !== null && String(row[key]).trim()) {
                return String(row[key]).trim();
              }
              // Tenta varia√ß√µes com/sem espa√ßos
              for (const col of Object.keys(row)) {
                if (col.trim().toUpperCase() === key.toUpperCase()) {
                  if (row[col] !== undefined && row[col] !== null && String(row[col]).trim()) {
                    return String(row[col]).trim();
                  }
                }
              }
            }
            return '';
          };

          // Mapear TODAS as linhas que tenham ALGUM dado √∫til
          let ignoredCount = 0;
          allData = [];
          
          parsed.data.forEach((row, index) => {
            const area = getValue(row, '√ÅREA', '√Årea', 'AREA', 'Area', '√°rea');
            const acao = getValue(row, 'O QU√ä?', 'O QUE?', 'O Qu√™?', 'O que?', 'A√á√ÉO', 'A√ß√£o', 'ACAO', 'Acao', 'a√ß√£o', 'O QUE');
            const status = getValue(row, 'STATUS', 'Status', 'status');
            const prioridade = getValue(row, 'PRIORIDADE', 'Prioridade', 'prioridade');
            const responsavel = getValue(row, 'QUEM?', 'QUEM', 'Quem?', 'Quem', 'Respons√°vel', 'Responsavel', 'respons√°vel', 'RESPONS√ÅVEL');
            const prazo = getValue(row, 'PRAZO', 'Prazo', 'prazo', 'QUANDO?', 'Quando?', 'QUANDO');

            // CRIT√âRIO DE INCLUS√ÉO: linha tem √ÅREA OU A√á√ÉO preenchida
            // (antes era √ÅREA E A√á√ÉO, o que exclu√≠a linhas v√°lidas)
            const hasArea = area.length > 0;
            const hasAcao = acao.length > 0;
            
            if (hasArea || hasAcao) {
              allData.push({
                area: area || 'Sem √Årea',
                acao: acao || 'Sem descri√ß√£o',
                status: normalizeStatus(status),
                prioridade: prioridade.toUpperCase() || '',
                responsavel: responsavel,
                prazo: prazo
              });
            } else {
              // Log das linhas ignoradas para debug
              const rowValues = Object.values(row).filter(v => v && String(v).trim());
              if (rowValues.length > 0) {
                console.log(`‚ö†Ô∏è Linha ${index + 2} ignorada:`, row);
                ignoredCount++;
              }
            }
          });

          console.log(`‚úÖ ${allData.length} a√ß√µes carregadas`);
          console.log(`‚ö†Ô∏è ${ignoredCount} linhas com dados mas sem √ÅREA/A√á√ÉO`);
          
          if (allData.length > 0) {
            // Mostrar amostra dos dados
            console.log('üìä Amostra dos dados:', allData.slice(0, 3));
            
            // Contar por √°rea para validar
            const areaCount = {};
            allData.forEach(a => {
              areaCount[a.area] = (areaCount[a.area] || 0) + 1;
            });
            console.log('üìä Contagem por √°rea:', areaCount);
            
            success = true; 
            isUsingDemo = false;
            break;
          }
          throw new Error('Sem dados v√°lidos');
        } catch (e) { 
          console.warn('‚ùå', e.message); 
          lastError = e; 
        }
      }

      if (btn) { btn.disabled = false; btn.innerHTML = 'üîÑ Atualizar'; }
      success ? showDashboard() : showError(lastError?.message);
    }

    function useDemoData() { allData = [...demoData]; isUsingDemo = true; showDashboard(); }

    function showError(msg) {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('errorState').classList.remove('hidden');
      document.getElementById('errorMessage').textContent = msg;
      document.getElementById('syncIndicator').className = 'w-2.5 h-2.5 rounded-full bg-red-500';
      document.getElementById('syncStatus').textContent = 'Desconectado';
    }

    function showDashboard() {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('errorState').classList.add('hidden');
      document.getElementById('dashboardContent').classList.remove('hidden');
      document.getElementById('demoBanner').classList.toggle('hidden', !isUsingDemo);
      document.getElementById('syncIndicator').className = `w-2.5 h-2.5 rounded-full ${isUsingDemo ? 'bg-amber-400' : 'bg-green-400 pulse'}`;
      document.getElementById('syncStatus').textContent = isUsingDemo ? 'Demonstra√ß√£o' : 'Conectado';
      document.getElementById('lastUpdate').textContent = new Date().toLocaleString('pt-BR');
      updateDashboard();
    }

    function updateDashboard() {
      const t = {
        total: allData.length,
        concluido: allData.filter(a => a.status === 'CONCLU√çDO').length,
        emAndamento: allData.filter(a => a.status === 'EM ANDAMENTO').length,
        pendente: allData.filter(a => a.status === 'PENDENTE').length,
        atrasado: allData.filter(a => a.status === 'ATRASADO').length
      };
      t.percent = t.total > 0 ? Math.round((t.concluido / t.total) * 100) : 0;

      document.getElementById('metricTotal').textContent = t.total;
      document.getElementById('metricPercent').textContent = `${t.percent}% conclu√≠do`;
      document.getElementById('metricConcluido').textContent = t.concluido;
      document.getElementById('metricAndamento').textContent = t.emAndamento;
      document.getElementById('metricPendente').textContent = t.pendente;
      document.getElementById('metricAtrasado').textContent = t.atrasado;
      document.getElementById('progressBar').style.width = `${t.percent}%`;
      document.getElementById('progressPercent').textContent = `${t.percent}%`;
      document.getElementById('progressText').textContent = `${t.concluido} de ${t.total} a√ß√µes conclu√≠das`;

      updateCharts(t); updateAreaProgress(); updateFilters(); filterTable();
    }

    function updateCharts(t) {
      if (pieChart) pieChart.destroy();
      if (barChart) barChart.destroy();

      pieChart = new Chart(document.getElementById('pieChart'), {
        type: 'doughnut',
        data: {
          labels: ['Conclu√≠do', 'Em Andamento', 'Pendente', 'Atrasado'],
          datasets: [{ data: [t.concluido, t.emAndamento, t.pendente, t.atrasado], backgroundColor: [colors.concluido, colors.emAndamento, colors.pendente, colors.atrasado], borderWidth: 4, borderColor: '#fff' }]
        },
        options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { position: 'bottom' } } }
      });

      const areas = [...new Set(allData.map(d => d.area))].filter(a => a && a !== 'Sem √Årea').sort();
      const ad = areas.map(area => {
        const items = allData.filter(d => d.area === area);
        return {
          area: area.replace('Comercial | ', '').substring(0, 12),
          c: items.filter(a => a.status === 'CONCLU√çDO').length,
          e: items.filter(a => a.status === 'EM ANDAMENTO').length,
          p: items.filter(a => a.status === 'PENDENTE').length,
          a: items.filter(a => a.status === 'ATRASADO').length
        };
      });

      barChart = new Chart(document.getElementById('barChart'), {
        type: 'bar',
        data: {
          labels: ad.map(d => d.area),
          datasets: [
            { label: 'Conclu√≠do', data: ad.map(d => d.c), backgroundColor: colors.concluido },
            { label: 'Em Andamento', data: ad.map(d => d.e), backgroundColor: colors.emAndamento },
            { label: 'Pendente', data: ad.map(d => d.p), backgroundColor: colors.pendente },
            { label: 'Atrasado', data: ad.map(d => d.a), backgroundColor: colors.atrasado }
          ]
        },
        options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { stacked: true }, y: { stacked: true } }, plugins: { legend: { position: 'bottom' } } }
      });
    }

    function updateAreaProgress() {
      const areas = [...new Set(allData.map(d => d.area))].filter(a => a && a !== 'Sem √Årea').sort();
      const container = document.getElementById('areaProgress');
      container.innerHTML = '';
      areas.forEach(area => {
        const items = allData.filter(d => d.area === area);
        const total = items.length;
        const c = items.filter(a => a.status === 'CONCLU√çDO').length;
        const e = items.filter(a => a.status === 'EM ANDAMENTO').length;
        const p = items.filter(a => a.status === 'PENDENTE').length;
        const a = items.filter(a => a.status === 'ATRASADO').length;
        const pct = total > 0 ? Math.round((c / total) * 100) : 0;
        container.innerHTML += `
          <div class="p-4 rounded-xl border-2 hover-scale" style="background: var(--bege); border-color: ${pct >= 50 ? colors.concluido + '40' : 'var(--bege-escuro)'}">
            <div class="flex justify-between items-center mb-3">
              <span class="font-bold text-sm" style="color: var(--verde-escuro)">${area}</span>
              <span class="text-xl font-extrabold" style="color: ${pct >= 50 ? colors.concluido : colors.pendente}">${pct}%</span>
            </div>
            <div class="w-full bg-white rounded-full h-3 overflow-hidden shadow-inner">
              <div class="h-3 rounded-full progress-bar" style="width: ${pct}%; background: ${pct >= 50 ? colors.concluido : colors.pendente}"></div>
            </div>
            <div class="flex gap-3 mt-3 text-xs font-bold flex-wrap">
              <span style="color: ${colors.concluido}">‚úÖ ${c}</span>
              <span style="color: ${colors.emAndamento}">üîÑ ${e}</span>
              <span style="color: ${colors.pendente}">‚è≥ ${p}</span>
              ${a > 0 ? `<span style="color: ${colors.atrasado}">‚ö†Ô∏è ${a}</span>` : ''}
            </div>
          </div>`;
      });
    }

    function updateFilters() {
      const areas = [...new Set(allData.map(d => d.area))].filter(a => a && a !== 'Sem √Årea').sort();
      const sel = document.getElementById('filterArea');
      sel.innerHTML = '<option value="">üè¢ Todas as √Åreas</option>' + areas.map(a => `<option value="${a}">${a}</option>`).join('');
    }

    function changePageSize() {
      pageSize = parseInt(document.getElementById('pageSize').value);
      currentPage = 1;
      filterTable();
    }

    function goToPage(page) {
      if (page < 1 || page > totalPages) return;
      currentPage = page;
      renderTable();
    }

    function filterTable() {
      const af = document.getElementById('filterArea').value;
      const sf = document.getElementById('filterStatus').value;
      filteredData = allData.filter(d => d.area && d.area !== 'Sem √Årea');
      if (af) filteredData = filteredData.filter(d => d.area === af);
      if (sf) filteredData = filteredData.filter(d => d.status === normalizeStatus(sf));
      
      // Resetar para p√°gina 1 ao filtrar
      currentPage = 1;
      totalPages = Math.ceil(filteredData.length / pageSize) || 1;
      
      renderTable();
    }

    function renderTable() {
      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = Math.min(startIndex + pageSize, filteredData.length);
      const pageData = filteredData.slice(startIndex, endIndex);
      
      document.getElementById('tableCount').textContent = `${filteredData.length} a√ß√µes encontradas`;
      document.getElementById('totalFiltered').textContent = filteredData.length;
      document.getElementById('showingRange').textContent = filteredData.length > 0 
        ? `Mostrando ${startIndex + 1}-${endIndex}` 
        : 'Mostrando 0-0';
      document.getElementById('pageInfo').textContent = `${currentPage} / ${totalPages}`;
      
      // Atualizar estado dos bot√µes
      document.getElementById('btnFirst').disabled = currentPage === 1;
      document.getElementById('btnPrev').disabled = currentPage === 1;
      document.getElementById('btnNext').disabled = currentPage === totalPages;
      document.getElementById('btnLast').disabled = currentPage === totalPages;
      
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';
      
      const sc = { 'CONCLU√çDO': colors.concluido, 'EM ANDAMENTO': colors.emAndamento, 'PENDENTE': colors.pendente, 'ATRASADO': colors.atrasado };
      const pc = { 'ALTA': colors.atrasado, 'M√âDIA': colors.pendente, 'MEDIA': colors.pendente, 'BAIXA': colors.concluido };
      const si = { 'CONCLU√çDO': '‚úÖ', 'EM ANDAMENTO': 'üîÑ', 'PENDENTE': '‚è≥', 'ATRASADO': '‚ö†Ô∏è' };

      pageData.forEach((item, i) => {
        tbody.innerHTML += `
          <tr class="border-b hover:bg-gray-50 ${i % 2 ? 'bg-gray-50/50' : 'bg-white'}" style="border-color: var(--bege-escuro)">
            <td class="px-4 py-3 font-bold" style="color: var(--verde-escuro)">${item.area}</td>
            <td class="px-4 py-3 text-gray-600" title="${item.acao}">${item.acao.length > 50 ? item.acao.substring(0, 50) + '...' : item.acao}</td>
            <td class="px-4 py-3 text-gray-500">${item.responsavel || '-'}</td>
            <td class="px-4 py-3 text-gray-500">${item.prazo || '-'}</td>
            <td class="px-4 py-3">${item.prioridade ? `<span class="px-3 py-1 rounded-full text-white text-xs font-bold" style="background: ${pc[item.prioridade] || '#9CA3AF'}">${item.prioridade}</span>` : '-'}</td>
            <td class="px-4 py-3"><span class="px-3 py-1 rounded-full text-white text-xs font-bold" style="background: ${sc[item.status] || colors.pendente}">${si[item.status] || '‚è≥'} ${item.status}</span></td>
          </tr>`;
      });
      
      if (pageData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-10 text-center text-gray-400">Nenhuma a√ß√£o encontrada</td></tr>';
      }
    }

    setInterval(() => { if (!isUsingDemo) fetchData(); }, 120000);
    fetchData();
  </script>
</body>
</html>
